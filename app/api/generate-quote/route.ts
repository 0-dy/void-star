import { NextResponse } from "next/server";

interface Quote {
    text: string;
    source: string;
    keywords: string[];
}

// Curated database of cinematic quotes categorized by genre and mood keywords
const QUOTE_DATABASE: Record<string, Quote[]> = {
    "느와르": [
        { text: `"니가 가라 호와이."`, source: "- 친구 (2001)", keywords: ["배신", "실망", "친구", "원망", "체념"] },
        { text: `"살려는 드릴게."`, source: "- 신세계 (2013)", keywords: ["위협", "복수", "자신감", "여유", "화남"] },
        { text: `"내가 빙다리 핫바지로 보이냐?"`, source: "- 타짜 (2006)", keywords: ["의심", "분노", "무시", "짜증", "억울", "화남"] },
        { text: `"야, 4885. 너지?"`, source: "- 추격자 (2008)", keywords: ["집착", "분노", "공포", "의심", "추적"] },
        { text: `"호의가 계속되면, 그게 권리인 줄 알아요."`, source: "- 부당거래 (2010)", keywords: ["실망", "배신", "짜증", "교훈", "답답", "호의", "권리"] },
        { text: `"누구냐 넌?"`, source: "- 올드보이 (2003)", keywords: ["혼란", "복수", "의문", "과거", "고독", "외로움", "누구"] },
        { text: `"지금까지 이런 맛은 없었다. 이것은 갈비인가 통닭인가."`, source: "- 극한직업 (2019)", keywords: ["성공", "기쁨", "유쾌", "반전", "황당", "맛", "배고픔"] },
        { text: `"꼭 그렇게 다 가져가야만 속이 후련했냐!"`, source: "- 해바라기 (2006)", keywords: ["억울", "분노", "슬픔", "절망", "상실", "후회", "화남"] },
        { text: `"어이가 없네?"`, source: "- 베테랑 (2015)", keywords: ["황당", "어이없음", "분노", "짜증", "어이"] },
        { text: `"거 장난이 너무 심한 거 아니오!"`, source: "- 신세계 (2013)", keywords: ["당황", "원망", "불만", "절망", "장난"] },
        { text: `"너나 잘하세요."`, source: "- 친절한 금자씨 (2005)", keywords: ["무시", "냉소", "분노", "짜증", "당당", "간섭"] },
        { text: `"나 이대 나온 여자야."`, source: "- 타짜 (2006)", keywords: ["자신감", "체면", "당당", "자존심", "자랑"] },
        { text: `"마이 뭇따 아이가, 고마 해라..."`, source: "- 친구 (2001)", keywords: ["포기", "체념", "고통", "끝", "아픔", "그만"] },
        // 미국 영화 (범죄/느와르성)
        { text: `"내가 거절할 수 없는 제안을 하겠다."`, source: "- 대부 (1972, 미국 아카데미 작품상)", keywords: ["협상", "권력", "위협", "단호", "결단"] },
        { text: `"친구는 가까이 두고, 적은 더 가까이 두어라."`, source: "- 대부 2 (1974, 미국 아카데미 작품상)", keywords: ["경계", "조심", "지혜", "위기진단", "전략"] },
        { text: `"안녕이라고 말해라, 내 작은 친구에게!"`, source: "- 스카페이스 (1983, 미국)", keywords: ["광기", "분노", "폭발", "화남", "마지막"] },
        { text: `"내가 널 만든 건 아니지만, 널 파괴할 순 있지."`, source: "- 트레이닝 데이 (2001, 미국 아카데미 남우주연상)", keywords: ["권력", "위협", "경고", "배신", "우위"] },
        { text: `"세상에서 가장 큰 속임수는 악마가 자신은 존재하지 않는다고 세상을 설득한 것이다."`, source: "- 유주얼 서스펙트 (1995, 미국 아카데미 각본상)", keywords: ["거짓", "속임수", "반전", "충격", "악"] },
        { text: `"무슨 일이 일어나도, 영원히 널 사랑해."`, source: "- 바닐라 스카이 (2001, 미국)", keywords: ["진심", "애틋", "절망 속 사랑", "슬픔"] },
        { text: `"우리가 하는 일은 메아리처럼 영원히 남는다."`, source: "- 글래디에이터 (2000, 미국 아카데미 작품상)", keywords: ["운명", "결과", "책임", "장엄", "의지"] },
        { text: `"나에게 말하는 거야? 나한테 말하는 거냐고?!"`, source: "- 택시 드라이버 (1976, 프랑스 칸 황금종려상/미국)", keywords: ["분노", "고독", "소외", "광기", "반항"] },
        // 일본 (스릴러/느와르풍)
        { text: `"내일 일어날 일은 아무도 모른다."`, source: "- 아무도 모른다 (2004, 일본 칸 남우주연상)", keywords: ["체념", "막막함", "우울", "슬픔", "현실"] },
        { text: `"거짓말을 하는 건, 그럴만한 이유가 있기 때문이다."`, source: "- 라쇼몽 (1950, 일본 베니스 금사자상)", keywords: ["진실", "거짓", "인간성", "의심", "이유"] },
        { text: `"가장 잔인한 괴물은 인간의 형태를 하고 있다."`, source: "- 고백 (2010, 일본 아카데미 작품상)", keywords: ["인간성", "공포", "잔혹", "충격", "괴물"] },
        { text: `"복수는 차갑게 식혀 먹어야 맛있는 음식과 같다."`, source: "- 킬 빌 (2003, 미국/일본 오마주)", keywords: ["복수", "인내", "단호", "결심", "차가움"] }
    ],
    "SF": [
        { text: `"우린 답을 찾을 거야, 늘 그랬듯이."`, source: "- 인터스텔라 (2014) (한국 극장가 대흥행작)", keywords: ["희망", "도전", "위기", "극복", "미래", "답", "해결"] },
        { text: `"내가 진짜 누군지 나도 모르겠어."`, source: "- 승리호 (2021)", keywords: ["정체성", "혼란", "방황", "외로움", "자아", "모르겠어"] },
        { text: `"시간은 흐르지 않아. 단지 우리가 그 사이를 걸어갈 뿐이지."`, source: "- 외계+인 1부 (2022)", keywords: ["시간", "깨달음", "철학", "운명", "과거", "미래"] },
        { text: `"과거 수리가 곧 미래입니다."`, source: "- 원더랜드 (2024)", keywords: ["후회", "과거", "재건", "상실", "희망", "미래", "수리"] },
        { text: `"인간은 결국 자신이 만든 피조물에게 지배당할 수밖에 없는가."`, source: "- 정이 (2023)", keywords: ["두려움", "후회", "운명", "기술", "절망"] },
        { text: `"모든 생명은 결국 한 곳으로 모이게 되어 있어."`, source: "- 설국열차 (2013)", keywords: ["운명", "순리", "철학", "죽음", "끝", "만남"] },
        { text: `"우주선은 떠났고, 우리는 남겨졌다."`, source: "- 승리호 (2021)", keywords: ["외로움", "고립", "절망", "포기", "상실", "남겨짐"] },
        { text: `"기억을 아무리 지워도 흉터는 남는 법이지."`, source: "- 마녀 (2018)", keywords: ["상처", "트라우마", "과거", "고통", "기억", "흉터"] },
        { text: `"너는 내가 만든 가장 완벽한 피조물이야."`, source: "- 서복 (2021)", keywords: ["자부심", "존재", "생명", "목적", "사랑", "완벽"] },
        { text: `"이제 곧 비가 그칠 거야... 영원히."`, source: "- 마녀(魔女) Part2. (2022)", keywords: ["끝", "종말", "차분함", "체념", "위안"] },
        // 스웨덴, 미국 영화
        { text: `"모든 기억은 빗속의 눈물처럼 사라지겠지."`, source: "- 블레이드 러너 (1982, 미국)", keywords: ["허무", "슬픔", "사라짐", "죽음", "기억", "눈물"] },
        { text: `"살고 싶다면 나와 함께 가자."`, source: "- 터미네이터 2: 심판의 날 (1991, 미국 아카데미 4개부문)", keywords: ["구원", "도움", "결단", "희망", "생존"] },
        { text: `"선택은 환상이다. 권력이 있는 자가 만들어낸 것일 뿐."`, source: "- 매트릭스 리로디드 (2003, 미국)", keywords: ["통제", "운명", "허상", "깨달음", "선택"] },
        { text: `"알 제 9구역에 온 걸 환영한다."`, source: "- 디스트릭트 9 (2009, 미국 아카데미 노미네이트)", keywords: ["차별", "고립", "절망", "위기", "낯섬"] },
        { text: `"우리가 우주에서 유일한 생명체라면, 그것은 엄청난 공간의 낭비일 것이다."`, source: "- 콘택트 (1997, 미국)", keywords: ["경외", "존재", "희망", "우주", "궁금증"] },
        { text: `"당신이 진실이라고 믿는 것이 곧 현실이다."`, source: "- 메트로폴리스 (1927, 독일/유럽 클래식 SF)", keywords: ["현실", "진실", "믿음", "환상", "세상"] },
        { text: `"기계는 생각할 수 있는가? 아니, 인간은 생각할 수 있는가?"`, source: "- 엑스 마키나 (2014, 미국/유럽 아카데미 시각효과상)", keywords: ["인간", "철학", "질문", "기계", "본질"] }
    ],
    "로맨스": [
        { text: `"사랑을 노력한다는 게 말이 돼?"`, source: "- 8월의 크리스마스 (1998)", keywords: ["사랑", "이별", "단념", "의문", "아픔", "노력"] },
        { text: `"어떻게 사랑이 변하니?"`, source: "- 봄날은 간다 (2001)", keywords: ["배신", "실망", "이별", "슬픔", "상실", "변함"] },
        { text: `"내 머릿속에 지우개가 있대."`, source: "- 내 머리 속의 지우개 (2004)", keywords: ["슬픔", "망각", "두려움", "사랑", "애틋", "기억"] },
        { text: `"우리가 세상을 바꿀 순 없겠지만, 세상이 우리를 바꾸게 내버려두진 않을 거야."`, source: "- 1987 (2017)", keywords: ["희망", "의지", "사랑", "다짐", "용기", "세상"] },
        { text: `"나한테 왜 그랬어? 말해봐요."`, source: "- 달콤한 인생 (2005)", keywords: ["서운함", "원망", "상실", "배신", "슬픔", "이유"] },
        { text: `"너의 췌장을 먹고 싶어."`, source: "- 너의 췌장을 먹고 싶어 (2017)", keywords: ["고백", "진심", "가까움", "이해", "애틋", "사랑해"] },
        { text: `"당신은 나를 더 좋은 사람이 되고 싶게 만들어요."`, source: "- 이보다 더 좋을 순 없다 (1997) (한국인 애착 명대사)", keywords: ["사랑", "행복", "동기", "성장", "설렘", "좋은", "기쁨"] },
        { text: `"나 다시 돌아갈래!"`, source: "- 박하사탕 (1999)", keywords: ["후회", "과거", "절망", "그리움", "슬픔", "돌아갈래"] },
        { text: `"사랑해. 네가 어떤 모습이든, 어떤 선택을 하든."`, source: "- 뷰티 인사이드 (2015)", keywords: ["이해", "수용", "사랑", "다정", "진심", "위로"] },
        { text: `"우리 진짜 사귀는 거 맞아요?"`, source: "- 헤어질 결심 (2022)", keywords: ["의심", "불안", "관계", "애틋", "확인", "진심"] },
        { text: `"비가 온다고 해서 꼭 우산을 써야 하는 건 아니잖아."`, source: "- 연애소설 (2002)", keywords: ["자유", "일탈", "낭만", "사랑", "청춘", "여유"] },
        { text: `"기억해, 내가 널 사랑했던 시간들을."`, source: "- 클래식 (2003)", keywords: ["추억", "그리움", "아련함", "눈물", "이별", "시간"] },
        // 프랑스, 일본, 미국 수상작 로맨스
        { text: `"우리의 삶에서 유일하게 의미 있는 것은 누군가를 사랑하고, 사랑받는 것입니다."`, source: "- 마담 보바리 (1991, 프랑스)", keywords: ["사랑", "가치", "인생", "의미", "진정성"] },
        { text: `"사랑은 눈으로 보는 것이 아니라, 마음으로 보는 거야."`, source: "- 라 라 랜드 (2016, 미국 아카데미 6관왕)", keywords: ["사랑", "꿈", "낭만", "설렘", "마음"] },
        { text: `"당신을 만나기 전까지, 내 인생은 흑백이었어요."`, source: "- 로마의 휴일 (1953, 미국 아카데미 여우주연상)", keywords: ["시작", "생기", "사랑", "운명", "행복"] },
        { text: `"진정한 사랑은 조용하게 온다."`, source: "- 러브레터 (1995, 일본 아카데미 우수작품상)", keywords: ["그리움", "편안함", "아련", "사랑", "잔잔함", "오겡끼데스까"] },
        { text: `"잘 지내고 있나요? 저는 잘 지내고 있습니다."`, source: "- 러브레터 (1995, 일본 아카데미 우수작품상)", keywords: ["안부", "이별", "안도", "추억", "인사", "아련함"] },
        { text: `"파리는 언제나 좋은 생각이죠."`, source: "- 사브리나 (1954, 미국 아카데미 의상상)", keywords: ["기대", "낭만", "행복", "여행", "도피"] },
        { text: `"나는 널 위해 수천 개의 바람이 될게."`, source: "- 아멜리에 (2001, 프랑스 칸/세자르상)", keywords: ["소망", "희생", "헌신", "귀여움", "유쾌함"] },
        { text: `"당신은 내가 매일 아침 일어나는 유일한 이유예요."`, source: "- 미 비포 유 (2016, 미국/영국)", keywords: ["존재", "이유", "사랑", "간절함", "단 하나"] },
        { text: `"사람은 사랑할 때 누구나 시인이 된다."`, source: "- 일 포스티노 (1994, 이탈리아/프랑스 아카데미 음악상)", keywords: ["낭만", "아름다움", "영감", "설렘", "문학"] },
        { text: `"나의 인생은 당신의 것이오."`, source: "- 카사블랑카 (1942, 미국 아카데미 작품상)", keywords: ["순종", "헌신", "고전", "바침", "확신"] },
        { text: `"우리가 다시 만나지 못한다면, 좋은 아침, 좋은 오후, 그리고 좋은 밤 되길 바랍니다."`, source: "- 트루먼 쇼 (1998, 미국 골든 글로브)", keywords: ["이별", "축복", "따뜻함", "안녕", "마지막"] }
    ],
    "철학적": [
        { text: `"뭣이 중헌디, 뭣이 중허냐고!"`, source: "- 곡성 (2016)", keywords: ["답답", "분노", "방황", "가치", "우선순위", "짜증", "중요"] },
        { text: `"사람이 언제 제일 예쁜 줄 알아? 죽을 준비가 다 됐을 때야."`, source: "- 마더 (2009)", keywords: ["허상", "체념", "아름다움", "죽음", "깨달음", "마지막"] },
        { text: `"밥은 먹고 다니냐?"`, source: "- 살인의 추억 (2003)", keywords: ["안부", "쓸쓸함", "연민", "분노", "인간성", "밥", "걱정"] },
        { text: `"인생은 초콜릿 상자와 같은 거야. 네가 무엇을 고를지 아무도 모르잖니."`, source: "- 포레스트 검프 (1994) (클래식 명대사)", keywords: ["인생", "운명", "희망", "불확실성", "기대", "미래"] },
        { text: `"세상이 끝났다고 생각했을 때, 비로소 진짜 삶이 시작되었다."`, source: "- 설국열차 (2013)", keywords: ["시작", "희망", "재건", "생존", "변화", "끝"] },
        { text: `"선 넘는 사람들, 내가 제일 싫어하는데."`, source: "- 기생충 (2019)", keywords: ["불쾌", "예의", "경고", "짜증", "거리감", "선"] },
        { text: `"가장 완벽한 계획이 뭔지 알아? 무계획이야."`, source: "- 기생충 (2019, 칸 황금종려상/아카데미 작품상)", keywords: ["체념", "우울", "현실", "포기", "인생", "계획", "실망"] },
        { text: `"알려줘야지, 우린 계속 싸우고 있다고."`, source: "- 암살 (2015)", keywords: ["의지", "희망", "인내", "다짐", "저항", "싸움"] },
        { text: `"운명은 시계탑의 추처럼 일정한 박자로 움직이지 않는다."`, source: "- 관상 (2013)", keywords: ["운명", "불안", "철학", "인생", "불확실", "미래"] },
        { text: `"이게 다 무슨 소용이야, 결국엔 다 흙으로 돌아갈 텐데."`, source: "- 사도 (2015)", keywords: ["허무", "슬픔", "인생", "우울", "죽음", "단념"] },
        { text: `"우리가 세상을 구하는 게 아니라, 세상이 우리를 구하는 거야."`, source: "- 신과함께 (2017)", keywords: ["구원", "희망", "인간", "철학", "위로", "세상"] },
        // 프랑스, 스웨덴, 일본, 미국 철학 영화
        { text: `"신은 침묵하지만, 인간은 끊임없이 말을 건다."`, source: "- 제7의 봉인 (1957, 스웨덴 칸 심사위원특별상)", keywords: ["고독", "신", "종교", "의문", "존재", "침묵"] },
        { text: `"인간의 유일한 질병은 고독이다."`, source: "- 산딸기 (1957, 스웨덴 베를린 황금곰상)", keywords: ["외로움", "우울", "본질", "사람", "슬픔"] },
        { text: `"우리는 모두 시궁창 속에 있지만, 그들 중 누군가는 별을 바라본다."`, source: "- 도리안 그레이의 초상 (영국/미국 철학적 명언 인용)", keywords: ["희망", "비참함", "꿈", "동경", "이상"] },
        { text: `"나의 모든 행위는 나를 찾는 과정이다."`, source: "- 페르소나 (1966, 스웨덴 전미비평가협회 작품상)", keywords: ["자아", "정체성", "혼란", "인생", "자성"] },
        { text: `"눈물을 흘리지 않는다고 해서, 슬프지 않은 것은 아니다."`, source: "- 동경 이야기 (1953, 일본 BFI 선정 역대 최고의 영화 중 하나)", keywords: ["참음", "슬픔", "가족", "인생", "억누름", "아픔"] },
        { text: `"진실은 단 하나가 아닙니다. 사람의 수만큼 진실이 존재하죠."`, source: "- 고레에다 히로카즈 감독의 괴물 (2023, 일본 칸 각본상)", keywords: ["진실", "이해", "관점", "다양성", "인간관계"] },
        { text: `"인생은 멀리서 보면 희극이지만, 가까이서 보면 비극이다."`, source: "- 모던 타임스 (1936, 미국 찰리 채플린)", keywords: ["고통", "풍자", "위로", "인생", "거리"] },
        { text: `"가장 깊은 바다는 가장 고요하다."`, source: "- 그랑블루 (1988, 프랑스 세자르상)", keywords: ["평온", "안식", "위안", "침묵", "위대함"] },
        { text: `"인생은 속도에 있는 것이 아니라 방향에 있다."`, source: "- 레 미제라블 (2012, 미국/프랑스 원작)", keywords: ["초조", "불안", "결명", "길", "지향점"] },
        { text: `"카르페 디엠. 현재를 즐겨라, 소년들이여. 너희의 삶을 비범하게 만들어라."`, source: "- 죽은 시인의 사회 (1989, 미국 아카데미 각본상)", keywords: ["용기", "청춘", "현재", "도전", "열정", "가치"] },
        { text: `"행복은 나눌 때 비로소 진정한 것이 된다."`, source: "- 인투 더 와일드 (2007, 미국)", keywords: ["나눔", "행복", "가치", "깨달음", "고독"] },
        { text: `"때로는 우리가 가장 두려워하는 것이, 우리가 찾아 헤매던 진실일지 모른다."`, source: "- 피아니스트 (2002, 프랑스/폴란드/영국 칸 황금종려상)", keywords: ["두려움", "진실", "회피", "직면", "고통"] },
        { text: `"세상은 당신이 바라보는 방식에 따라 달라집니다."`, source: "- 세 가지 색: 블루 (1993, 프랑스 베니스 황금사자상)", keywords: ["자유", "선택", "시선", "관점", "마음먹기"] }
    ]
};

export async function POST(req: Request) {
    try {
        const { mood = "", genre } = await req.json();

        if (!genre) {
            return NextResponse.json(
                { error: "Genre is required" },
                { status: 400 }
            );
        }

        // Simulate AI thinking time to keep the premium feel
        await new Promise((resolve) => setTimeout(resolve, 1500));

        // Get quotes for the selected genre
        const categoryQuotes = QUOTE_DATABASE[genre] || QUOTE_DATABASE["느와르"];

        // 1. Analyze mood and weight related quotes
        // Find quotes whose keywords overlap with the user's mood string
        let matchingQuotes = categoryQuotes.filter(quote =>
            quote.keywords.some(keyword => mood.includes(keyword))
        );

        // 2. If no keywords match, fallback to choosing from the whole genre array
        if (matchingQuotes.length === 0) {
            matchingQuotes = categoryQuotes;
        }

        // Select a random quote from the filtered or fallback list
        const randomIndex = Math.floor(Math.random() * matchingQuotes.length);
        const selectedQuoteData = matchingQuotes[randomIndex];

        // Format quote string for frontend backwards compatibility
        const formattedQuote = `${selectedQuoteData.text}\n${selectedQuoteData.source}`;

        return NextResponse.json({ quote: formattedQuote });
    } catch (error) {
        console.error("Error generating quote:", error);
        return NextResponse.json(
            { error: "Failed to generate quote" },
            { status: 500 }
        );
    }
}

